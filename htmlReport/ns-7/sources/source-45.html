


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=windows-1252"> 
  <title>Coverage Report > JcaTemplate</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">io.jsonwebtoken.impl.security</a>
</div>

<h1>Coverage Summary for Class: JcaTemplate (io.jsonwebtoken.impl.security)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">JcaTemplate</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (33/33)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    79.4%
  </span>
  <span class="absValue">
    (27/34)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (70/70)
  </span>
</td>
</tr>
  <tr>
    <td class="name">JcaTemplate$1</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">JcaTemplate$10</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (3/3)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">JcaTemplate$2</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">JcaTemplate$3</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (9/9)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">JcaTemplate$4</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (3/3)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">JcaTemplate$5</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">JcaTemplate$6</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (3/3)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">JcaTemplate$7</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (3/3)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">JcaTemplate$8</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">JcaTemplate$9</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (7/7)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">JcaTemplate$AlgorithmParametersFactory</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (4/4)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">JcaTemplate$CertificateFactoryFactory</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (4/4)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">JcaTemplate$CipherFactory</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">JcaTemplate$generatePrivate$0</td>
  </tr>
  <tr>
    <td class="name">JcaTemplate$generatePrivate$4</td>
  </tr>
  <tr>
    <td class="name">JcaTemplate$generatePublic</td>
  </tr>
  <tr>
    <td class="name">JcaTemplate$generateSecretKey$2</td>
  </tr>
  <tr>
    <td class="name">JcaTemplate$generateX509Certificate$1</td>
  </tr>
  <tr>
    <td class="name">JcaTemplate$generateX509Certificate$6</td>
  </tr>
  <tr>
    <td class="name">JcaTemplate$InstanceFactory</td>
  </tr>
  <tr>
    <td class="name">JcaTemplate$JcaInstanceFactory</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (7/7)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    95%
  </span>
  <span class="absValue">
    (19/20)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    91.4%
  </span>
  <span class="absValue">
    (32/35)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">JcaTemplate$KeyAgreementFactory</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">JcaTemplate$KeyFactoryFactory</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">JcaTemplate$KeyGeneratorFactory</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">JcaTemplate$KeyPairGeneratorFactory</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">JcaTemplate$MacFactory</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">JcaTemplate$MessageDigestFactory</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">JcaTemplate$SecretKeyFactoryFactory</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">JcaTemplate$SignatureFactory</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">JcaTemplate$withCertificateFactory$5</td>
  </tr>
  <tr>
    <td class="name">JcaTemplate$withCipher$3</td>
  </tr>
  <tr>
    <td class="name">JcaTemplate$withKeyPairGenerator$7</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (82/82)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    90%
  </span>
  <span class="absValue">
    (72/80)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    98.2%
  </span>
  <span class="absValue">
    (164/167)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/*
&nbsp; * Copyright (C) 2021 jsonwebtoken.io
&nbsp; *
&nbsp; * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
&nbsp; * you may not use this file except in compliance with the License.
&nbsp; * You may obtain a copy of the License at
&nbsp; *
&nbsp; *     http://www.apache.org/licenses/LICENSE-2.0
&nbsp; *
&nbsp; * Unless required by applicable law or agreed to in writing, software
&nbsp; * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
&nbsp; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&nbsp; * See the License for the specific language governing permissions and
&nbsp; * limitations under the License.
&nbsp; */
&nbsp;package io.jsonwebtoken.impl.security;
&nbsp;
&nbsp;import io.jsonwebtoken.Identifiable;
&nbsp;import io.jsonwebtoken.impl.io.Streams;
&nbsp;import io.jsonwebtoken.impl.lang.Bytes;
&nbsp;import io.jsonwebtoken.impl.lang.CheckedFunction;
&nbsp;import io.jsonwebtoken.impl.lang.CheckedSupplier;
&nbsp;import io.jsonwebtoken.impl.lang.DefaultRegistry;
&nbsp;import io.jsonwebtoken.impl.lang.Function;
&nbsp;import io.jsonwebtoken.lang.Assert;
&nbsp;import io.jsonwebtoken.lang.Collections;
&nbsp;import io.jsonwebtoken.lang.Objects;
&nbsp;import io.jsonwebtoken.lang.Registry;
&nbsp;import io.jsonwebtoken.lang.Strings;
&nbsp;import io.jsonwebtoken.security.SecurityException;
&nbsp;import io.jsonwebtoken.security.SignatureException;
&nbsp;
&nbsp;import javax.crypto.Cipher;
&nbsp;import javax.crypto.KeyAgreement;
&nbsp;import javax.crypto.KeyGenerator;
&nbsp;import javax.crypto.Mac;
&nbsp;import javax.crypto.NoSuchPaddingException;
&nbsp;import javax.crypto.SecretKey;
&nbsp;import javax.crypto.SecretKeyFactory;
&nbsp;import java.io.InputStream;
&nbsp;import java.security.AlgorithmParameters;
&nbsp;import java.security.InvalidAlgorithmParameterException;
&nbsp;import java.security.InvalidKeyException;
&nbsp;import java.security.KeyFactory;
&nbsp;import java.security.KeyPair;
&nbsp;import java.security.KeyPairGenerator;
&nbsp;import java.security.MessageDigest;
&nbsp;import java.security.NoSuchAlgorithmException;
&nbsp;import java.security.PrivateKey;
&nbsp;import java.security.Provider;
&nbsp;import java.security.PublicKey;
&nbsp;import java.security.SecureRandom;
&nbsp;import java.security.Signature;
&nbsp;import java.security.cert.CertificateException;
&nbsp;import java.security.cert.CertificateFactory;
&nbsp;import java.security.cert.X509Certificate;
&nbsp;import java.security.spec.AlgorithmParameterSpec;
&nbsp;import java.security.spec.InvalidKeySpecException;
&nbsp;import java.security.spec.KeySpec;
&nbsp;import java.security.spec.PKCS8EncodedKeySpec;
&nbsp;import java.util.List;
&nbsp;import java.util.concurrent.ConcurrentHashMap;
&nbsp;import java.util.concurrent.ConcurrentMap;
&nbsp;
<b class="fc">&nbsp;public class JcaTemplate {</b>
&nbsp;
<b class="fc">&nbsp;    private static final List&lt;InstanceFactory&lt;?&gt;&gt; FACTORIES = Collections.&lt;InstanceFactory&lt;?&gt;&gt;of(</b>
&nbsp;            new CipherFactory(),
&nbsp;            new KeyFactoryFactory(),
&nbsp;            new SecretKeyFactoryFactory(),
&nbsp;            new KeyGeneratorFactory(),
&nbsp;            new KeyPairGeneratorFactory(),
&nbsp;            new KeyAgreementFactory(),
&nbsp;            new MessageDigestFactory(),
&nbsp;            new SignatureFactory(),
&nbsp;            new MacFactory(),
&nbsp;            new AlgorithmParametersFactory(),
&nbsp;            new CertificateFactoryFactory()
&nbsp;    );
&nbsp;
<b class="fc">&nbsp;    private static final Registry&lt;Class&lt;?&gt;, InstanceFactory&lt;?&gt;&gt; REGISTRY = new DefaultRegistry&lt;&gt;(</b>
&nbsp;            &quot;JCA Instance Factory&quot;, &quot;instance class&quot;, FACTORIES,
<b class="fc">&nbsp;            new Function&lt;InstanceFactory&lt;?&gt;, Class&lt;?&gt;&gt;() {</b>
&nbsp;                @Override
&nbsp;                public Class&lt;?&gt; apply(InstanceFactory&lt;?&gt; factory) {
<b class="fc">&nbsp;                    return factory.getInstanceClass();</b>
&nbsp;                }
&nbsp;            });
&nbsp;
&nbsp;    // visible for testing
&nbsp;    protected Provider findBouncyCastle() {
<b class="fc">&nbsp;        return Providers.findBouncyCastle();</b>
&nbsp;    }
&nbsp;
&nbsp;    private final String jcaName;
&nbsp;    private final Provider provider;
&nbsp;    private final SecureRandom secureRandom;
&nbsp;
&nbsp;    JcaTemplate(String jcaName) {
<b class="fc">&nbsp;        this(jcaName, null);</b>
&nbsp;    }
&nbsp;
&nbsp;    JcaTemplate(String jcaName, Provider provider) {
<b class="fc">&nbsp;        this(jcaName, provider, null);</b>
&nbsp;    }
&nbsp;
<b class="fc">&nbsp;    JcaTemplate(String jcaName, Provider provider, SecureRandom secureRandom) {</b>
<b class="fc">&nbsp;        this.jcaName = Assert.hasText(jcaName, &quot;jcaName string cannot be null or empty.&quot;);</b>
<b class="fc">&nbsp;        this.secureRandom = secureRandom != null ? secureRandom : Randoms.secureRandom();</b>
<b class="fc">&nbsp;        this.provider = provider; //may be null, meaning to use the JCA subsystem default provider</b>
&nbsp;    }
&nbsp;
&nbsp;    private &lt;T, R&gt; R execute(Class&lt;T&gt; clazz, CheckedFunction&lt;T, R&gt; callback, Provider provider) throws Exception {
<b class="fc">&nbsp;        InstanceFactory&lt;?&gt; factory = REGISTRY.get(clazz);</b>
<b class="fc">&nbsp;        Assert.notNull(factory, &quot;Unsupported JCA instance class.&quot;);</b>
&nbsp;
<b class="fc">&nbsp;        Object object = factory.get(this.jcaName, provider);</b>
<b class="fc">&nbsp;        T instance = Assert.isInstanceOf(clazz, object, &quot;Factory instance does not match expected type.&quot;);</b>
&nbsp;
<b class="fc">&nbsp;        return callback.apply(instance);</b>
&nbsp;    }
&nbsp;
&nbsp;    private &lt;T&gt; T execute(Class&lt;?&gt; clazz, CheckedSupplier&lt;T&gt; fn) throws SecurityException {
&nbsp;        try {
<b class="fc">&nbsp;            return fn.get();</b>
<b class="fc">&nbsp;        } catch (SecurityException se) {</b>
<b class="fc">&nbsp;            throw se; //propagate</b>
<b class="fc">&nbsp;        } catch (Throwable t) {</b>
<b class="fc">&nbsp;            String msg = clazz.getSimpleName() + &quot; callback execution failed: &quot; + t.getMessage();</b>
<b class="fc">&nbsp;            throw new SecurityException(msg, t);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private &lt;T, R&gt; R execute(final Class&lt;T&gt; clazz, final CheckedFunction&lt;T, R&gt; fn) throws SecurityException {
<b class="fc">&nbsp;        return execute(clazz, new CheckedSupplier&lt;R&gt;() {</b>
&nbsp;            @Override
&nbsp;            public R get() throws Exception {
<b class="fc">&nbsp;                return execute(clazz, fn, JcaTemplate.this.provider);</b>
&nbsp;            }
&nbsp;        });
&nbsp;    }
&nbsp;
&nbsp;    protected &lt;T, R&gt; R fallback(final Class&lt;T&gt; clazz, final CheckedFunction&lt;T, R&gt; callback) throws SecurityException {
<b class="fc">&nbsp;        return execute(clazz, new CheckedSupplier&lt;R&gt;() {</b>
&nbsp;            @Override
&nbsp;            public R get() throws Exception {
&nbsp;                try {
<b class="fc">&nbsp;                    return execute(clazz, callback, JcaTemplate.this.provider);</b>
<b class="fc">&nbsp;                } catch (Exception e) {</b>
&nbsp;                    try { // fallback
<b class="fc">&nbsp;                        Provider bc = findBouncyCastle();</b>
<b class="fc">&nbsp;                        if (bc != null) {</b>
<b class="fc">&nbsp;                            return execute(clazz, callback, bc);</b>
&nbsp;                        }
<b class="fc">&nbsp;                    } catch (Throwable ignored) { // report original exception instead</b>
<b class="fc">&nbsp;                    }</b>
<b class="fc">&nbsp;                    throw e;</b>
&nbsp;                }
&nbsp;            }
&nbsp;        });
&nbsp;    }
&nbsp;
&nbsp;    public &lt;R&gt; R withCipher(CheckedFunction&lt;Cipher, R&gt; fn) throws SecurityException {
<b class="fc">&nbsp;        return execute(Cipher.class, fn);</b>
&nbsp;    }
&nbsp;
&nbsp;    public &lt;R&gt; R withKeyFactory(CheckedFunction&lt;KeyFactory, R&gt; fn) throws SecurityException {
<b class="fc">&nbsp;        return execute(KeyFactory.class, fn);</b>
&nbsp;    }
&nbsp;
&nbsp;    public &lt;R&gt; R withSecretKeyFactory(CheckedFunction&lt;SecretKeyFactory, R&gt; fn) throws SecurityException {
<b class="fc">&nbsp;        return execute(SecretKeyFactory.class, fn);</b>
&nbsp;    }
&nbsp;
&nbsp;    public &lt;R&gt; R withKeyGenerator(CheckedFunction&lt;KeyGenerator, R&gt; fn) throws SecurityException {
<b class="fc">&nbsp;        return execute(KeyGenerator.class, fn);</b>
&nbsp;    }
&nbsp;
&nbsp;    public &lt;R&gt; R withKeyAgreement(CheckedFunction&lt;KeyAgreement, R&gt; fn) throws SecurityException {
<b class="fc">&nbsp;        return execute(KeyAgreement.class, fn);</b>
&nbsp;    }
&nbsp;
&nbsp;    public &lt;R&gt; R withKeyPairGenerator(CheckedFunction&lt;KeyPairGenerator, R&gt; fn) throws SecurityException {
<b class="fc">&nbsp;        return execute(KeyPairGenerator.class, fn);</b>
&nbsp;    }
&nbsp;
&nbsp;    public &lt;R&gt; R withMessageDigest(CheckedFunction&lt;MessageDigest, R&gt; fn) throws SecurityException {
<b class="fc">&nbsp;        return execute(MessageDigest.class, fn);</b>
&nbsp;    }
&nbsp;
&nbsp;    public &lt;R&gt; R withSignature(CheckedFunction&lt;Signature, R&gt; fn) throws SecurityException {
<b class="fc">&nbsp;        return execute(Signature.class, fn);</b>
&nbsp;    }
&nbsp;
&nbsp;    public &lt;R&gt; R withMac(CheckedFunction&lt;Mac, R&gt; fn) throws SecurityException {
<b class="fc">&nbsp;        return execute(Mac.class, fn);</b>
&nbsp;    }
&nbsp;
&nbsp;    public &lt;R&gt; R withAlgorithmParameters(CheckedFunction&lt;AlgorithmParameters, R&gt; fn) throws SecurityException {
<b class="fc">&nbsp;        return execute(AlgorithmParameters.class, fn);</b>
&nbsp;    }
&nbsp;
&nbsp;    public &lt;R&gt; R withCertificateFactory(CheckedFunction&lt;CertificateFactory, R&gt; fn) throws SecurityException {
<b class="fc">&nbsp;        return execute(CertificateFactory.class, fn);</b>
&nbsp;    }
&nbsp;
&nbsp;    public SecretKey generateSecretKey(final int keyBitLength) {
<b class="fc">&nbsp;        return withKeyGenerator(new CheckedFunction&lt;KeyGenerator, SecretKey&gt;() {</b>
&nbsp;            @Override
&nbsp;            public SecretKey apply(KeyGenerator generator) {
<b class="fc">&nbsp;                generator.init(keyBitLength, secureRandom);</b>
<b class="fc">&nbsp;                return generator.generateKey();</b>
&nbsp;            }
&nbsp;        });
&nbsp;    }
&nbsp;
&nbsp;    public KeyPair generateKeyPair() {
<b class="fc">&nbsp;        return withKeyPairGenerator(new CheckedFunction&lt;KeyPairGenerator, KeyPair&gt;() {</b>
&nbsp;            @Override
&nbsp;            public KeyPair apply(KeyPairGenerator gen) {
<b class="fc">&nbsp;                return gen.generateKeyPair();</b>
&nbsp;            }
&nbsp;        });
&nbsp;    }
&nbsp;
&nbsp;    public KeyPair generateKeyPair(final int keyBitLength) {
<b class="fc">&nbsp;        return withKeyPairGenerator(new CheckedFunction&lt;KeyPairGenerator, KeyPair&gt;() {</b>
&nbsp;            @Override
&nbsp;            public KeyPair apply(KeyPairGenerator generator) {
<b class="fc">&nbsp;                generator.initialize(keyBitLength, secureRandom);</b>
<b class="fc">&nbsp;                return generator.generateKeyPair();</b>
&nbsp;            }
&nbsp;        });
&nbsp;    }
&nbsp;
&nbsp;    public KeyPair generateKeyPair(final AlgorithmParameterSpec params) {
<b class="fc">&nbsp;        return withKeyPairGenerator(new CheckedFunction&lt;KeyPairGenerator, KeyPair&gt;() {</b>
&nbsp;            @Override
&nbsp;            public KeyPair apply(KeyPairGenerator generator) throws InvalidAlgorithmParameterException {
<b class="fc">&nbsp;                generator.initialize(params, secureRandom);</b>
<b class="fc">&nbsp;                return generator.generateKeyPair();</b>
&nbsp;            }
&nbsp;        });
&nbsp;    }
&nbsp;
&nbsp;    public PublicKey generatePublic(final KeySpec spec) {
<b class="fc">&nbsp;        return fallback(KeyFactory.class, new CheckedFunction&lt;KeyFactory, PublicKey&gt;() {</b>
&nbsp;            @Override
&nbsp;            public PublicKey apply(KeyFactory keyFactory) throws Exception {
<b class="fc">&nbsp;                return keyFactory.generatePublic(spec);</b>
&nbsp;            }
&nbsp;        });
&nbsp;    }
&nbsp;
&nbsp;    protected boolean isJdk11() {
<b class="fc">&nbsp;        return System.getProperty(&quot;java.version&quot;).startsWith(&quot;11&quot;);</b>
&nbsp;    }
&nbsp;
&nbsp;    private boolean isJdk8213363Bug(InvalidKeySpecException e) {
<b class="fc">&nbsp;        return isJdk11() &amp;&amp;</b>
<b class="pc">&nbsp;                (&quot;XDH&quot;.equals(this.jcaName) || &quot;X25519&quot;.equals(this.jcaName) || &quot;X448&quot;.equals(this.jcaName)) &amp;&amp;</b>
<b class="pc">&nbsp;                e.getCause() instanceof InvalidKeyException &amp;&amp;</b>
<b class="pc">&nbsp;                !Objects.isEmpty(e.getStackTrace()) &amp;&amp;</b>
<b class="pc">&nbsp;                &quot;sun.security.ec.XDHKeyFactory&quot;.equals(e.getStackTrace()[0].getClassName()) &amp;&amp;</b>
<b class="pc">&nbsp;                &quot;engineGeneratePrivate&quot;.equals(e.getStackTrace()[0].getMethodName());</b>
&nbsp;    }
&nbsp;
&nbsp;    // visible for testing
&nbsp;    private int getJdk8213363BugExpectedSize(InvalidKeyException e) {
<b class="fc">&nbsp;        String msg = e.getMessage();</b>
<b class="fc">&nbsp;        String prefix = &quot;key length must be &quot;;</b>
<b class="fc">&nbsp;        if (Strings.hasText(msg) &amp;&amp; msg.startsWith(prefix)) {</b>
<b class="fc">&nbsp;            String expectedSizeString = msg.substring(prefix.length());</b>
&nbsp;            try {
<b class="fc">&nbsp;                return Integer.parseInt(expectedSizeString);</b>
<b class="fc">&nbsp;            } catch (NumberFormatException ignored) { // return -1 below</b>
&nbsp;            }
&nbsp;        }
<b class="fc">&nbsp;        return -1;</b>
&nbsp;    }
&nbsp;
&nbsp;    private KeySpec respecIfNecessary(InvalidKeySpecException e, KeySpec spec) {
<b class="fc">&nbsp;        if (!(spec instanceof PKCS8EncodedKeySpec)) {</b>
<b class="fc">&nbsp;            return null;</b>
&nbsp;        }
<b class="fc">&nbsp;        PKCS8EncodedKeySpec pkcs8Spec = (PKCS8EncodedKeySpec) spec;</b>
<b class="fc">&nbsp;        byte[] encoded = pkcs8Spec.getEncoded();</b>
&nbsp;
&nbsp;        // Address the [JDK 11 SunCE provider bug](https://bugs.openjdk.org/browse/JDK-8213363) for X25519
&nbsp;        // and X448 encoded keys: Even though the key material might be encoded properly, JDK 11&#39;s
&nbsp;        // SunCE provider incorrectly expects an ASN.1 OCTET STRING (without the DER tag/length prefix)
&nbsp;        // when it should actually be a BER-encoded OCTET STRING (with the tag/length prefix).
&nbsp;        // So we get the raw key bytes and use our key factory method:
<b class="fc">&nbsp;        if (isJdk8213363Bug(e)) {</b>
<b class="fc">&nbsp;            InvalidKeyException cause = // asserted in isJdk8213363Bug method</b>
<b class="fc">&nbsp;                    Assert.isInstanceOf(InvalidKeyException.class, e.getCause(), &quot;Unexpected argument.&quot;);</b>
<b class="fc">&nbsp;            int size = getJdk8213363BugExpectedSize(cause);</b>
<b class="pc">&nbsp;            if ((size == 32 || size == 56) &amp;&amp; Bytes.length(encoded) &gt;= size) {</b>
<b class="fc">&nbsp;                byte[] adjusted = new byte[size];</b>
<b class="fc">&nbsp;                System.arraycopy(encoded, encoded.length - size, adjusted, 0, size);</b>
<b class="fc">&nbsp;                EdwardsCurve curve = size == 32 ? EdwardsCurve.X25519 : EdwardsCurve.X448;</b>
<b class="fc">&nbsp;                return curve.privateKeySpec(adjusted, false);</b>
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        return null;</b>
&nbsp;    }
&nbsp;
&nbsp;    // visible for testing
&nbsp;    protected PrivateKey generatePrivate(KeyFactory factory, KeySpec spec) throws InvalidKeySpecException {
<b class="fc">&nbsp;        return factory.generatePrivate(spec);</b>
&nbsp;    }
&nbsp;
&nbsp;    public PrivateKey generatePrivate(final KeySpec spec) {
<b class="fc">&nbsp;        return fallback(KeyFactory.class, new CheckedFunction&lt;KeyFactory, PrivateKey&gt;() {</b>
&nbsp;            @Override
&nbsp;            public PrivateKey apply(KeyFactory keyFactory) throws Exception {
&nbsp;                try {
<b class="fc">&nbsp;                    return generatePrivate(keyFactory, spec);</b>
<b class="fc">&nbsp;                } catch (InvalidKeySpecException e) {</b>
<b class="fc">&nbsp;                    KeySpec respec = respecIfNecessary(e, spec);</b>
<b class="fc">&nbsp;                    if (respec != null) {</b>
<b class="fc">&nbsp;                        return generatePrivate(keyFactory, respec);</b>
&nbsp;                    }
<b class="fc">&nbsp;                    throw e; // could not respec, propagate</b>
&nbsp;                }
&nbsp;            }
&nbsp;        });
&nbsp;    }
&nbsp;
&nbsp;    public X509Certificate generateX509Certificate(final byte[] x509DerBytes) {
<b class="fc">&nbsp;        return fallback(CertificateFactory.class, new CheckedFunction&lt;CertificateFactory, X509Certificate&gt;() {</b>
&nbsp;            @Override
&nbsp;            public X509Certificate apply(CertificateFactory cf) throws CertificateException {
<b class="fc">&nbsp;                InputStream is = Streams.of(x509DerBytes);</b>
<b class="fc">&nbsp;                return (X509Certificate) cf.generateCertificate(is);</b>
&nbsp;            }
&nbsp;        });
&nbsp;    }
&nbsp;
&nbsp;    private interface InstanceFactory&lt;T&gt; extends Identifiable {
&nbsp;
&nbsp;        Class&lt;T&gt; getInstanceClass();
&nbsp;
&nbsp;        T get(String jcaName, Provider provider) throws Exception;
&nbsp;    }
&nbsp;
&nbsp;    private static abstract class JcaInstanceFactory&lt;T&gt; implements InstanceFactory&lt;T&gt; {
&nbsp;
&nbsp;        private final Class&lt;T&gt; clazz;
&nbsp;
&nbsp;        // Boolean value: missing/null = haven&#39;t attempted, true = attempted and succeeded, false = attempted and failed
<b class="fc">&nbsp;        private final ConcurrentMap&lt;String, Boolean&gt; FALLBACK_ATTEMPTS = new ConcurrentHashMap&lt;&gt;();</b>
&nbsp;
<b class="fc">&nbsp;        JcaInstanceFactory(Class&lt;T&gt; clazz) {</b>
<b class="fc">&nbsp;            this.clazz = Assert.notNull(clazz, &quot;Class argument cannot be null.&quot;);</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public Class&lt;T&gt; getInstanceClass() {
<b class="fc">&nbsp;            return this.clazz;</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public String getId() {
<b class="fc">&nbsp;            return clazz.getSimpleName();</b>
&nbsp;        }
&nbsp;
&nbsp;        // visible for testing
&nbsp;        protected Provider findBouncyCastle() {
<b class="fc">&nbsp;            return Providers.findBouncyCastle();</b>
&nbsp;        }
&nbsp;
&nbsp;        @SuppressWarnings(&quot;GrazieInspection&quot;)
&nbsp;        @Override
&nbsp;        public final T get(String jcaName, final Provider specifiedProvider) throws Exception {
<b class="fc">&nbsp;            Assert.hasText(jcaName, &quot;jcaName cannot be null or empty.&quot;);</b>
<b class="fc">&nbsp;            Provider provider = specifiedProvider;</b>
<b class="fc">&nbsp;            final Boolean attempted = FALLBACK_ATTEMPTS.get(jcaName);</b>
<b class="pc">&nbsp;            if (provider == null &amp;&amp; attempted != null &amp;&amp; attempted) {</b>
&nbsp;                // We tried with the default provider previously, and needed to fallback, so just
&nbsp;                // preemptively load the fallback to avoid the fallback/retry again:
<b class="nc">&nbsp;                provider = findBouncyCastle();</b>
&nbsp;            }
&nbsp;            try {
<b class="fc">&nbsp;                return doGet(jcaName, provider);</b>
<b class="fc">&nbsp;            } catch (NoSuchAlgorithmException nsa) { // try to fallback if possible</b>
&nbsp;
<b class="fc">&nbsp;                if (specifiedProvider == null &amp;&amp; attempted == null) { // default provider doesn&#39;t support the alg name,</b>
&nbsp;                    // and we haven&#39;t tried BC yet, so try that now:
<b class="fc">&nbsp;                    Provider fallback = findBouncyCastle();</b>
<b class="fc">&nbsp;                    if (fallback != null) { // BC found, try again:</b>
&nbsp;                        try {
<b class="fc">&nbsp;                            T value = doGet(jcaName, fallback);</b>
&nbsp;                            // record the successful attempt so we don&#39;t have to do this again:
<b class="nc">&nbsp;                            FALLBACK_ATTEMPTS.putIfAbsent(jcaName, Boolean.TRUE);</b>
<b class="nc">&nbsp;                            return value;</b>
<b class="fc">&nbsp;                        } catch (Throwable ignored) {</b>
&nbsp;                            // record the failed attempt so we don&#39;t keep trying and propagate original exception:
<b class="fc">&nbsp;                            FALLBACK_ATTEMPTS.putIfAbsent(jcaName, Boolean.FALSE);</b>
&nbsp;                        }
&nbsp;                    }
&nbsp;                }
&nbsp;                // otherwise, we tried the fallback, or there isn&#39;t a fallback, so no need to try again, so
&nbsp;                // propagate the exception:
<b class="fc">&nbsp;                throw wrap(nsa, jcaName, specifiedProvider, null);</b>
<b class="fc">&nbsp;            } catch (Exception e) {</b>
<b class="fc">&nbsp;                throw wrap(e, jcaName, specifiedProvider, null);</b>
&nbsp;            }
&nbsp;        }
&nbsp;
&nbsp;        protected abstract T doGet(String jcaName, Provider provider) throws Exception;
&nbsp;
&nbsp;        // visible for testing:
&nbsp;        protected Exception wrap(Exception e, String jcaName, Provider specifiedProvider, Provider fallbackProvider) {
<b class="fc">&nbsp;            String msg = &quot;Unable to obtain &#39;&quot; + jcaName + &quot;&#39; &quot; + getId() + &quot; instance from &quot;;</b>
<b class="fc">&nbsp;            if (specifiedProvider != null) {</b>
<b class="fc">&nbsp;                msg += &quot;specified &#39;&quot; + specifiedProvider + &quot;&#39; Provider&quot;;</b>
&nbsp;            } else {
<b class="fc">&nbsp;                msg += &quot;default JCA Provider&quot;;</b>
&nbsp;            }
<b class="fc">&nbsp;            if (fallbackProvider != null) {</b>
<b class="fc">&nbsp;                msg += &quot; or fallback &#39;&quot; + fallbackProvider + &quot;&#39; Provider&quot;;</b>
&nbsp;            }
<b class="fc">&nbsp;            msg += &quot;: &quot; + e.getMessage();</b>
<b class="fc">&nbsp;            return wrap(msg, e);</b>
&nbsp;        }
&nbsp;
&nbsp;        protected Exception wrap(String msg, Exception cause) {
<b class="fc">&nbsp;            if (Signature.class.isAssignableFrom(clazz) || Mac.class.isAssignableFrom(clazz)) {</b>
<b class="fc">&nbsp;                return new SignatureException(msg, cause);</b>
&nbsp;            }
<b class="fc">&nbsp;            return new SecurityException(msg, cause);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private static class CipherFactory extends JcaInstanceFactory&lt;Cipher&gt; {
&nbsp;        CipherFactory() {
<b class="fc">&nbsp;            super(Cipher.class);</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public Cipher doGet(String jcaName, Provider provider) throws NoSuchPaddingException, NoSuchAlgorithmException {
<b class="fc">&nbsp;            return provider != null ? Cipher.getInstance(jcaName, provider) : Cipher.getInstance(jcaName);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private static class KeyFactoryFactory extends JcaInstanceFactory&lt;KeyFactory&gt; {
&nbsp;        KeyFactoryFactory() {
<b class="fc">&nbsp;            super(KeyFactory.class);</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public KeyFactory doGet(String jcaName, Provider provider) throws NoSuchAlgorithmException {
<b class="fc">&nbsp;            return provider != null ? KeyFactory.getInstance(jcaName, provider) : KeyFactory.getInstance(jcaName);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private static class SecretKeyFactoryFactory extends JcaInstanceFactory&lt;SecretKeyFactory&gt; {
&nbsp;        SecretKeyFactoryFactory() {
<b class="fc">&nbsp;            super(SecretKeyFactory.class);</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public SecretKeyFactory doGet(String jcaName, Provider provider) throws NoSuchAlgorithmException {
<b class="fc">&nbsp;            return provider != null ? SecretKeyFactory.getInstance(jcaName, provider) : SecretKeyFactory.getInstance(jcaName);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private static class KeyGeneratorFactory extends JcaInstanceFactory&lt;KeyGenerator&gt; {
&nbsp;        KeyGeneratorFactory() {
<b class="fc">&nbsp;            super(KeyGenerator.class);</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public KeyGenerator doGet(String jcaName, Provider provider) throws NoSuchAlgorithmException {
<b class="fc">&nbsp;            return provider != null ? KeyGenerator.getInstance(jcaName, provider) : KeyGenerator.getInstance(jcaName);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private static class KeyPairGeneratorFactory extends JcaInstanceFactory&lt;KeyPairGenerator&gt; {
&nbsp;        KeyPairGeneratorFactory() {
<b class="fc">&nbsp;            super(KeyPairGenerator.class);</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public KeyPairGenerator doGet(String jcaName, Provider provider) throws NoSuchAlgorithmException {
<b class="fc">&nbsp;            return provider != null ? KeyPairGenerator.getInstance(jcaName, provider) : KeyPairGenerator.getInstance(jcaName);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private static class KeyAgreementFactory extends JcaInstanceFactory&lt;KeyAgreement&gt; {
&nbsp;        KeyAgreementFactory() {
<b class="fc">&nbsp;            super(KeyAgreement.class);</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public KeyAgreement doGet(String jcaName, Provider provider) throws NoSuchAlgorithmException {
<b class="fc">&nbsp;            return provider != null ? KeyAgreement.getInstance(jcaName, provider) : KeyAgreement.getInstance(jcaName);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private static class MessageDigestFactory extends JcaInstanceFactory&lt;MessageDigest&gt; {
&nbsp;        MessageDigestFactory() {
<b class="fc">&nbsp;            super(MessageDigest.class);</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public MessageDigest doGet(String jcaName, Provider provider) throws NoSuchAlgorithmException {
<b class="fc">&nbsp;            return provider != null ? MessageDigest.getInstance(jcaName, provider) : MessageDigest.getInstance(jcaName);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private static class SignatureFactory extends JcaInstanceFactory&lt;Signature&gt; {
&nbsp;        SignatureFactory() {
<b class="fc">&nbsp;            super(Signature.class);</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public Signature doGet(String jcaName, Provider provider) throws NoSuchAlgorithmException {
<b class="fc">&nbsp;            return provider != null ? Signature.getInstance(jcaName, provider) : Signature.getInstance(jcaName);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private static class MacFactory extends JcaInstanceFactory&lt;Mac&gt; {
&nbsp;        MacFactory() {
<b class="fc">&nbsp;            super(Mac.class);</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public Mac doGet(String jcaName, Provider provider) throws NoSuchAlgorithmException {
<b class="fc">&nbsp;            return provider != null ? Mac.getInstance(jcaName, provider) : Mac.getInstance(jcaName);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private static class AlgorithmParametersFactory extends JcaInstanceFactory&lt;AlgorithmParameters&gt; {
&nbsp;        AlgorithmParametersFactory() {
<b class="fc">&nbsp;            super(AlgorithmParameters.class);</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        protected AlgorithmParameters doGet(String jcaName, Provider provider) throws Exception {
<b class="fc">&nbsp;            return provider != null ?</b>
<b class="fc">&nbsp;                    AlgorithmParameters.getInstance(jcaName, provider) :</b>
<b class="fc">&nbsp;                    AlgorithmParameters.getInstance(jcaName);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private static class CertificateFactoryFactory extends JcaInstanceFactory&lt;CertificateFactory&gt; {
&nbsp;        CertificateFactoryFactory() {
<b class="fc">&nbsp;            super(CertificateFactory.class);</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        protected CertificateFactory doGet(String jcaName, Provider provider) throws Exception {
<b class="fc">&nbsp;            return provider != null ?</b>
<b class="fc">&nbsp;                    CertificateFactory.getInstance(jcaName, provider) :</b>
<b class="fc">&nbsp;                    CertificateFactory.getInstance(jcaName);</b>
&nbsp;        }
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2023-11-02 22:24</div>
</div>
</body>
</html>
