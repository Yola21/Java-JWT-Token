


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=windows-1252"> 
  <title>Coverage Report > DefaultJwkContext</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">io.jsonwebtoken.impl.security</a>
</div>

<h1>Coverage Summary for Class: DefaultJwkContext (io.jsonwebtoken.impl.security)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">DefaultJwkContext</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (30/30)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    88.9%
  </span>
  <span class="absValue">
    (32/36)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (94/94)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/*
&nbsp; * Copyright (C) 2022 jsonwebtoken.io
&nbsp; *
&nbsp; * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
&nbsp; * you may not use this file except in compliance with the License.
&nbsp; * You may obtain a copy of the License at
&nbsp; *
&nbsp; *     http://www.apache.org/licenses/LICENSE-2.0
&nbsp; *
&nbsp; * Unless required by applicable law or agreed to in writing, software
&nbsp; * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
&nbsp; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&nbsp; * See the License for the specific language governing permissions and
&nbsp; * limitations under the License.
&nbsp; */
&nbsp;package io.jsonwebtoken.impl.security;
&nbsp;
&nbsp;import io.jsonwebtoken.impl.AbstractX509Context;
&nbsp;import io.jsonwebtoken.impl.lang.Parameter;
&nbsp;import io.jsonwebtoken.impl.lang.Parameters;
&nbsp;import io.jsonwebtoken.lang.Assert;
&nbsp;import io.jsonwebtoken.lang.Collections;
&nbsp;import io.jsonwebtoken.lang.Registry;
&nbsp;import io.jsonwebtoken.security.HashAlgorithm;
&nbsp;import io.jsonwebtoken.security.Jwks;
&nbsp;import io.jsonwebtoken.security.KeyOperation;
&nbsp;
&nbsp;import java.security.Key;
&nbsp;import java.security.PrivateKey;
&nbsp;import java.security.Provider;
&nbsp;import java.security.PublicKey;
&nbsp;import java.security.SecureRandom;
&nbsp;import java.util.Collection;
&nbsp;import java.util.LinkedHashSet;
&nbsp;import java.util.Map;
&nbsp;import java.util.Set;
&nbsp;
&nbsp;import static io.jsonwebtoken.lang.Strings.nespace;
&nbsp;
&nbsp;public class DefaultJwkContext&lt;K extends Key&gt; extends AbstractX509Context&lt;JwkContext&lt;K&gt;&gt; implements JwkContext&lt;K&gt; {
&nbsp;
&nbsp;    private static final Set&lt;Parameter&lt;?&gt;&gt; DEFAULT_PARAMS;
&nbsp;
&nbsp;    static { // assume all JWA params:
<b class="fc">&nbsp;        Set&lt;Parameter&lt;?&gt;&gt; set = new LinkedHashSet&lt;&gt;();</b>
<b class="fc">&nbsp;        set.addAll(DefaultSecretJwk.PARAMS); // Private/Secret JWKs has both public and private params</b>
<b class="fc">&nbsp;        set.addAll(DefaultEcPrivateJwk.PARAMS); // Private JWKs have both public and private params</b>
<b class="fc">&nbsp;        set.addAll(DefaultRsaPrivateJwk.PARAMS); // Private JWKs have both public and private params</b>
<b class="fc">&nbsp;        set.addAll(DefaultOctetPrivateJwk.PARAMS); // Private JWKs have both public and private params</b>
&nbsp;
&nbsp;        // EC JWKs and Octet JWKs have two params that are named identically, but have different type requirements.  So
&nbsp;        // we swap out those params with placeholders that allow either.  When the JwkContext is converted to its
&nbsp;        // type-specific context by the ProtoBuilder, the values will be correctly converted to their required types
&nbsp;        // at that time.  It is also important to retain toString security (via parameter.setSecret(true)) to ensure
&nbsp;        // any printing of the builder or its internal context does not print secure data.
<b class="fc">&nbsp;        set.remove(DefaultEcPublicJwk.X);</b>
<b class="fc">&nbsp;        set.remove(DefaultEcPrivateJwk.D);</b>
<b class="fc">&nbsp;        set.add(Parameters.string(DefaultEcPublicJwk.X.getId(), &quot;Elliptic Curve public key X coordinate&quot;));</b>
<b class="fc">&nbsp;        set.add(Parameters.builder(String.class).setSecret(true)</b>
<b class="fc">&nbsp;                .setId(DefaultEcPrivateJwk.D.getId()).setName(&quot;Elliptic Curve private key&quot;).build());</b>
&nbsp;
<b class="fc">&nbsp;        DEFAULT_PARAMS = Collections.immutable(set);</b>
&nbsp;    }
&nbsp;
&nbsp;    private K key;
&nbsp;    private PublicKey publicKey;
&nbsp;    private Provider provider;
&nbsp;
&nbsp;    private SecureRandom random;
&nbsp;
&nbsp;    private HashAlgorithm idThumbprintAlgorithm;
&nbsp;
&nbsp;    public DefaultJwkContext() {
&nbsp;        // For the default constructor case, we don&#39;t know how it will be used or what values will be populated,
&nbsp;        // so we can&#39;t know ahead of time what the sensitive data is.  As such, for security reasons, we assume all
&nbsp;        // the known params for all supported keys/algorithms in case it is used for any of them:
<b class="fc">&nbsp;        this(DEFAULT_PARAMS);</b>
&nbsp;    }
&nbsp;
&nbsp;    public DefaultJwkContext(Set&lt;Parameter&lt;?&gt;&gt; params) {
<b class="fc">&nbsp;        super(params);</b>
&nbsp;    }
&nbsp;
&nbsp;    public DefaultJwkContext(Set&lt;Parameter&lt;?&gt;&gt; params, JwkContext&lt;?&gt; other) {
<b class="fc">&nbsp;        this(params, other, true);</b>
&nbsp;    }
&nbsp;
&nbsp;    public DefaultJwkContext(Set&lt;Parameter&lt;?&gt;&gt; params, JwkContext&lt;?&gt; other, K key) {
&nbsp;        //if the key is null or a PublicKey, we don&#39;t want to redact - we want to fully remove the items that are
&nbsp;        //private names (public JWKs should never contain any private key params, even if redacted):
<b class="pc">&nbsp;        this(params, other, (key == null || key instanceof PublicKey));</b>
<b class="fc">&nbsp;        this.key = Assert.notNull(key, &quot;Key cannot be null.&quot;);</b>
&nbsp;    }
&nbsp;
&nbsp;    public DefaultJwkContext(Set&lt;Parameter&lt;?&gt;&gt; params, JwkContext&lt;?&gt; other, boolean removePrivate) {
<b class="fc">&nbsp;        super(Assert.notEmpty(params, &quot;Parameters cannot be null or empty.&quot;));</b>
<b class="fc">&nbsp;        Assert.notNull(other, &quot;JwkContext cannot be null.&quot;);</b>
<b class="fc">&nbsp;        Assert.isInstanceOf(DefaultJwkContext.class, other, &quot;JwkContext must be a DefaultJwkContext instance.&quot;);</b>
<b class="fc">&nbsp;        DefaultJwkContext&lt;?&gt; src = (DefaultJwkContext&lt;?&gt;) other;</b>
<b class="fc">&nbsp;        this.provider = other.getProvider();</b>
<b class="fc">&nbsp;        this.random = other.getRandom();</b>
<b class="fc">&nbsp;        this.idThumbprintAlgorithm = other.getIdThumbprintAlgorithm();</b>
<b class="fc">&nbsp;        this.values.putAll(src.values);</b>
&nbsp;        // Ensure the source&#39;s idiomatic values match the types expected by this object:
<b class="fc">&nbsp;        for (Map.Entry&lt;String, Object&gt; entry : src.idiomaticValues.entrySet()) {</b>
<b class="fc">&nbsp;            String id = entry.getKey();</b>
<b class="fc">&nbsp;            Object value = entry.getValue();</b>
<b class="fc">&nbsp;            Parameter&lt;?&gt; param = this.PARAMS.get(id);</b>
<b class="fc">&nbsp;            if (param != null &amp;&amp; !param.supports(value)) { // src idiomatic value is not what is expected, so convert:</b>
<b class="fc">&nbsp;                value = this.values.get(param.getId());</b>
<b class="fc">&nbsp;                put(param, value); // perform idiomatic conversion with original/raw src value</b>
&nbsp;            } else {
<b class="fc">&nbsp;                this.idiomaticValues.put(id, value);</b>
&nbsp;            }
<b class="fc">&nbsp;        }</b>
<b class="fc">&nbsp;        if (removePrivate) {</b>
<b class="fc">&nbsp;            for (Parameter&lt;?&gt; param : src.PARAMS.values()) {</b>
<b class="fc">&nbsp;                if (param.isSecret()) {</b>
<b class="fc">&nbsp;                    remove(param.getId());</b>
&nbsp;                }
<b class="fc">&nbsp;            }</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public JwkContext&lt;K&gt; parameter(Parameter&lt;?&gt; param) {
<b class="fc">&nbsp;        Registry&lt;String, ? extends Parameter&lt;?&gt;&gt; registry = Parameters.replace(this.PARAMS, param);</b>
<b class="fc">&nbsp;        Set&lt;Parameter&lt;?&gt;&gt; params = new LinkedHashSet&lt;&gt;(registry.values());</b>
<b class="fc">&nbsp;        return this.key != null ?</b>
<b class="fc">&nbsp;                new DefaultJwkContext&lt;&gt;(params, this, key) :</b>
<b class="fc">&nbsp;                new DefaultJwkContext&lt;K&gt;(params, this, false);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public String getName() {
<b class="fc">&nbsp;        String value = get(AbstractJwk.KTY);</b>
<b class="fc">&nbsp;        if (DefaultSecretJwk.TYPE_VALUE.equals(value)) {</b>
<b class="fc">&nbsp;            value = &quot;Secret&quot;;</b>
<b class="fc">&nbsp;        } else if (DefaultOctetPublicJwk.TYPE_VALUE.equals(value)) {</b>
<b class="fc">&nbsp;            value = &quot;Octet&quot;;</b>
&nbsp;        }
<b class="fc">&nbsp;        StringBuilder sb = value != null ? new StringBuilder(value) : new StringBuilder();</b>
<b class="fc">&nbsp;        K key = getKey();</b>
<b class="fc">&nbsp;        if (key instanceof PublicKey) {</b>
<b class="fc">&nbsp;            nespace(sb).append(&quot;Public&quot;);</b>
<b class="fc">&nbsp;        } else if (key instanceof PrivateKey) {</b>
<b class="fc">&nbsp;            nespace(sb).append(&quot;Private&quot;);</b>
&nbsp;        }
<b class="fc">&nbsp;        nespace(sb).append(&quot;JWK&quot;);</b>
<b class="fc">&nbsp;        return sb.toString();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void putAll(Map&lt;? extends String, ?&gt; m) {
<b class="fc">&nbsp;        Assert.notEmpty(m, &quot;JWK values cannot be null or empty.&quot;);</b>
<b class="fc">&nbsp;        super.putAll(m);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public String getAlgorithm() {
<b class="fc">&nbsp;        return get(AbstractJwk.ALG);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public JwkContext&lt;K&gt; setAlgorithm(String algorithm) {
<b class="fc">&nbsp;        put(AbstractJwk.ALG, algorithm);</b>
<b class="fc">&nbsp;        return this;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public String getId() {
<b class="fc">&nbsp;        return get(AbstractJwk.KID);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public JwkContext&lt;K&gt; setId(String id) {
<b class="fc">&nbsp;        put(AbstractJwk.KID, id);</b>
<b class="fc">&nbsp;        return this;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public JwkContext&lt;K&gt; setIdThumbprintAlgorithm(HashAlgorithm alg) {
<b class="fc">&nbsp;        this.idThumbprintAlgorithm = alg;</b>
<b class="fc">&nbsp;        return this;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public HashAlgorithm getIdThumbprintAlgorithm() {
<b class="fc">&nbsp;        return this.idThumbprintAlgorithm;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public Set&lt;KeyOperation&gt; getOperations() {
<b class="fc">&nbsp;        return get(AbstractJwk.KEY_OPS);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public JwkContext&lt;K&gt; setOperations(Collection&lt;? extends KeyOperation&gt; ops) {
<b class="fc">&nbsp;        put(AbstractJwk.KEY_OPS, ops);</b>
<b class="fc">&nbsp;        return this;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public String getType() {
<b class="fc">&nbsp;        return get(AbstractJwk.KTY);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public JwkContext&lt;K&gt; setType(String type) {
<b class="fc">&nbsp;        put(AbstractJwk.KTY, type);</b>
<b class="fc">&nbsp;        return this;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public String getPublicKeyUse() {
<b class="fc">&nbsp;        return get(AbstractAsymmetricJwk.USE);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public JwkContext&lt;K&gt; setPublicKeyUse(String use) {
<b class="fc">&nbsp;        put(AbstractAsymmetricJwk.USE, use);</b>
<b class="fc">&nbsp;        return this;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public boolean isSigUse() {
&nbsp;        // Even though &#39;use&#39; is for PUBLIC KEY use (as defined in RFC 7515), RFC 7520 shows secret keys with
&nbsp;        // &#39;use&#39; values, so we&#39;ll account for that as well:
<b class="fc">&nbsp;        if (&quot;sig&quot;.equals(getPublicKeyUse())) {</b>
<b class="fc">&nbsp;            return true;</b>
&nbsp;        }
<b class="fc">&nbsp;        Set&lt;KeyOperation&gt; ops = getOperations();</b>
<b class="fc">&nbsp;        if (Collections.isEmpty(ops)) {</b>
<b class="fc">&nbsp;            return false;</b>
&nbsp;        }
<b class="pc">&nbsp;        return ops.contains(Jwks.OP.SIGN) || ops.contains(Jwks.OP.VERIFY);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public K getKey() {
<b class="fc">&nbsp;        return this.key;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public JwkContext&lt;K&gt; setKey(K key) {
<b class="fc">&nbsp;        this.key = key;</b>
<b class="fc">&nbsp;        return this;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public PublicKey getPublicKey() {
<b class="fc">&nbsp;        return this.publicKey;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public JwkContext&lt;K&gt; setPublicKey(PublicKey publicKey) {
<b class="fc">&nbsp;        this.publicKey = publicKey;</b>
<b class="fc">&nbsp;        return this;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public Provider getProvider() {
<b class="fc">&nbsp;        return this.provider;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public JwkContext&lt;K&gt; setProvider(Provider provider) {
<b class="fc">&nbsp;        this.provider = provider;</b>
<b class="fc">&nbsp;        return this;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public SecureRandom getRandom() {
<b class="fc">&nbsp;        return this.random;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public JwkContext&lt;K&gt; setRandom(SecureRandom random) {
<b class="fc">&nbsp;        this.random = random;</b>
<b class="fc">&nbsp;        return this;</b>
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2023-11-02 22:24</div>
</div>
</body>
</html>
