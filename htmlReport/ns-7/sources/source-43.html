


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=windows-1252"> 
  <title>Coverage Report > GcmAesAeadAlgorithm</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">io.jsonwebtoken.impl.security</a>
</div>

<h1>Coverage Summary for Class: GcmAesAeadAlgorithm (io.jsonwebtoken.impl.security)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">GcmAesAeadAlgorithm</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (3/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (24/24)
  </span>
</td>
</tr>
  <tr>
    <td class="name">GcmAesAeadAlgorithm$1</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (8/8)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">GcmAesAeadAlgorithm$2</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (5/5)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (7/7)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (37/37)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/*
&nbsp; * Copyright (C) 2021 jsonwebtoken.io
&nbsp; *
&nbsp; * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
&nbsp; * you may not use this file except in compliance with the License.
&nbsp; * You may obtain a copy of the License at
&nbsp; *
&nbsp; *     http://www.apache.org/licenses/LICENSE-2.0
&nbsp; *
&nbsp; * Unless required by applicable law or agreed to in writing, software
&nbsp; * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
&nbsp; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&nbsp; * See the License for the specific language governing permissions and
&nbsp; * limitations under the License.
&nbsp; */
&nbsp;package io.jsonwebtoken.impl.security;
&nbsp;
&nbsp;import io.jsonwebtoken.impl.io.Streams;
&nbsp;import io.jsonwebtoken.impl.lang.Bytes;
&nbsp;import io.jsonwebtoken.impl.lang.CheckedFunction;
&nbsp;import io.jsonwebtoken.lang.Assert;
&nbsp;import io.jsonwebtoken.security.AeadAlgorithm;
&nbsp;import io.jsonwebtoken.security.AeadRequest;
&nbsp;import io.jsonwebtoken.security.AeadResult;
&nbsp;import io.jsonwebtoken.security.DecryptAeadRequest;
&nbsp;
&nbsp;import javax.crypto.Cipher;
&nbsp;import javax.crypto.SecretKey;
&nbsp;import java.io.InputStream;
&nbsp;import java.io.OutputStream;
&nbsp;import java.io.SequenceInputStream;
&nbsp;import java.security.spec.AlgorithmParameterSpec;
&nbsp;
&nbsp;/**
&nbsp; * @since 0.12.0
&nbsp; */
&nbsp;public class GcmAesAeadAlgorithm extends AesAlgorithm implements AeadAlgorithm {
&nbsp;
&nbsp;    private static final String TRANSFORMATION_STRING = &quot;AES/GCM/NoPadding&quot;;
&nbsp;
&nbsp;    public GcmAesAeadAlgorithm(int keyLength) {
<b class="fc">&nbsp;        super(&quot;A&quot; + keyLength + &quot;GCM&quot;, TRANSFORMATION_STRING, keyLength);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void encrypt(final AeadRequest req, AeadResult res) throws SecurityException {
&nbsp;
<b class="fc">&nbsp;        Assert.notNull(req, &quot;Request cannot be null.&quot;);</b>
<b class="fc">&nbsp;        Assert.notNull(res, &quot;Result cannot be null.&quot;);</b>
&nbsp;
<b class="fc">&nbsp;        final SecretKey key = assertKey(req.getKey());</b>
<b class="fc">&nbsp;        final InputStream plaintext = Assert.notNull(req.getPayload(),</b>
&nbsp;                &quot;Request content (plaintext) InputStream cannot be null.&quot;);
<b class="fc">&nbsp;        final OutputStream out = Assert.notNull(res.getOutputStream(),</b>
&nbsp;                &quot;Result ciphertext OutputStream cannot be null.&quot;);
<b class="fc">&nbsp;        final InputStream aad = req.getAssociatedData();</b>
<b class="fc">&nbsp;        final byte[] iv = ensureInitializationVector(req);</b>
<b class="fc">&nbsp;        final AlgorithmParameterSpec ivSpec = getIvSpec(iv);</b>
&nbsp;
<b class="fc">&nbsp;        final byte[] tag = jca(req).withCipher(new CheckedFunction&lt;Cipher, byte[]&gt;() {</b>
&nbsp;            @Override
&nbsp;            public byte[] apply(Cipher cipher) throws Exception {
<b class="fc">&nbsp;                cipher.init(Cipher.ENCRYPT_MODE, key, ivSpec);</b>
<b class="fc">&nbsp;                byte[] taggedCiphertext = withCipher(cipher, plaintext, aad, out);</b>
&nbsp;                // When using GCM mode, the JDK appends the authentication tag to the ciphertext, so let&#39;s extract it:
&nbsp;                // (tag has a length of BLOCK_BYTE_SIZE):
<b class="fc">&nbsp;                int ciphertextLength = Bytes.length(taggedCiphertext) - BLOCK_BYTE_SIZE;</b>
<b class="fc">&nbsp;                Streams.write(out, taggedCiphertext, 0, ciphertextLength, &quot;Ciphertext write failure.&quot;);</b>
<b class="fc">&nbsp;                byte[] tag = new byte[BLOCK_BYTE_SIZE];</b>
<b class="fc">&nbsp;                System.arraycopy(taggedCiphertext, ciphertextLength, tag, 0, BLOCK_BYTE_SIZE);</b>
<b class="fc">&nbsp;                return tag;</b>
&nbsp;            }
&nbsp;        });
<b class="fc">&nbsp;        Streams.flush(out);</b>
<b class="fc">&nbsp;        Streams.reset(plaintext);</b>
&nbsp;
<b class="fc">&nbsp;        res.setTag(tag).setIv(iv);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void decrypt(final DecryptAeadRequest req, final OutputStream out) throws SecurityException {
&nbsp;
<b class="fc">&nbsp;        Assert.notNull(req, &quot;Request cannot be null.&quot;);</b>
<b class="fc">&nbsp;        Assert.notNull(out, &quot;Plaintext OutputStream cannot be null.&quot;);</b>
<b class="fc">&nbsp;        final SecretKey key = assertKey(req.getKey());</b>
<b class="fc">&nbsp;        final InputStream ciphertext = Assert.notNull(req.getPayload(),</b>
&nbsp;                &quot;Decryption request content (ciphertext) InputStream cannot be null.&quot;);
<b class="fc">&nbsp;        final InputStream aad = req.getAssociatedData();</b>
<b class="fc">&nbsp;        final byte[] tag = Assert.notEmpty(req.getDigest(),</b>
&nbsp;                &quot;Decryption request authentication tag cannot be null or empty.&quot;);
<b class="fc">&nbsp;        final byte[] iv = assertDecryptionIv(req);</b>
<b class="fc">&nbsp;        final AlgorithmParameterSpec ivSpec = getIvSpec(iv);</b>
&nbsp;
&nbsp;        //for tagged GCM, the JCA spec requires that the tag be appended to the end of the ciphertext byte array:
<b class="fc">&nbsp;        final InputStream taggedCiphertext = new SequenceInputStream(ciphertext, Streams.of(tag));</b>
&nbsp;
<b class="fc">&nbsp;        jca(req).withCipher(new CheckedFunction&lt;Cipher, byte[]&gt;() {</b>
&nbsp;            @Override
&nbsp;            public byte[] apply(Cipher cipher) throws Exception {
<b class="fc">&nbsp;                cipher.init(Cipher.DECRYPT_MODE, key, ivSpec);</b>
<b class="fc">&nbsp;                byte[] last = withCipher(cipher, taggedCiphertext, aad, out);</b>
<b class="fc">&nbsp;                Streams.write(out, last, &quot;GcmAesAeadAlgorithm#decrypt plaintext write failure.&quot;);</b>
<b class="fc">&nbsp;                return Bytes.EMPTY;</b>
&nbsp;            }
&nbsp;        });
<b class="fc">&nbsp;        Streams.flush(out);</b>
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2023-11-02 22:24</div>
</div>
</body>
</html>
